stages:
  - linting
  - build
  - test
  - deploy

variables:
  # -------------- GitLab Configuration Variables -----------------------------
  REPO_TAG: registry.gitlab.com/${CI_PROJECT_ROOT_NAMESPACE}/${CI_PROJECT_NAME}

  # -------------- GCP Configuration Variables --------------------------------
  GCP_AR_REGION: northamerica-northeast2-docker.pkg.dev
  PROJECT_ID: cbd3345-2-sheena
  ARTIFACT_REGISTRY_REPOSITORY: app-dev-docker
  GCP_AR_TAG: $GCP_AR_REGION/$PROJECT_ID/$ARTIFACT_REGISTRY_REPOSITORY
  SERVICE_ACCOUNT_USER: gitlab-artifact-registry@cbd3345-2-sheena.iam.gserviceaccount.com

  # --------------- Main Pipeline Configuration --------------------------------
  IMAGE_TAG: ${GCP_AR_TAG}/${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}
  IMAGE_NAME: "expense-tracker"
  RUNNER_TAG: gcp-runner1-linux # agent to run the pipeline
  BASE_IMAGE: "base_image"
  BASE_IMAGE_TAG: ${GCP_AR_TAG}/${BASE_IMAGE_NAME}:latest

# GitLab built-in security templates
include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Container-Scanning.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml

.gcloud_auth:
  script:
    - gcloud config set project $PROJECT_ID
    - gcloud config set account $SERVICE_ACCOUNT_USER
    - gcloud auth configure-docker $GCP_AR_REGION

lint-job:
  stage: "linting"
  tags:
    - ${RUNNER_TAG}
  image: python:3.9-alpine
  before_script:
    - sudo apt-get update
    - sudo apt-get install -y make
    - sudo make setup
  script:
    - echo "Lint test for the application..."
    - sudo make linting

build:
  stage: "build"
  needs:
    - "lint-job"
  tags:
    - ${RUNNER_TAG}
  before_script:
    - gcloud auth configure-docker $GCP_AR_REGION
  script:
    - echo ${MONGO_URI} > .env
    - docker build -t ${IMAGE_TAG} --build-arg BASE_IMAGE=${GCP_AR_TAG}/${BASE_IMAGE_NAME}:latest -f Dockerfiles/Dockerfile .
    - docker push ${IMAGE_TAG}

unit-test-job:
  stage: "test"
  needs:
    - "build"
  tags:
    - ${RUNNER_TAG}
  image: ${BASE_IMAGE_TAG}
  before_script:
    - sudo apt-get update
    - sudo apt-get install -y make
  #    - make setup
  script:
    - echo "Running unit tests..."
    - sudo make unit-test

semgrep-sast:
  stage: "test"
  needs:
    - "build"
  artifacts:
    when: always
    expire_in: 30 days

secret_detection:
  stage: "test"
  needs:
    - "build"
  artifacts:
    when: always
    expire_in: 30 days

container_scanning:
  stage: "test"
  variables:
    CS_IMAGE: ${IMAGE_TAG}
    GIT_STRATEGY: clone
    CS_DOKCERFILE_PATH: ./Dockerfilebaseimage
  needs:
    - "build"
  artifacts:
    when: always
    expire_in: 30 days

deploy:
  stage: "deploy"
  tags:
    - ${RUNNER_TAG}
  before_script:
    - gcloud auth configure-docker $GCP_AR_REGION
  script:
    - docker pull ${IMAGE_TAG}
    - docker rm -f $IMAGE_NAME
    - docker rmi $(docker images -q $GCP_AR_TAG/$IMAGE_NAME)
    - docker run -d -p 5000:5000 --name ${IMAGE_NAME} ${IMAGE_TAG}
  needs: [ "semgrep-sast", "secret_detection", "container_scanning", "unit-test-job"]